#!/bin/bash

set -e

LAYER_NAME="mlflow_layer"
PYTHON_VERSION="3.10"
ZIP_NAME="mlflow-layer.zip"

# 1. Créer dossier propre
rm -rf $LAYER_NAME $ZIP_NAME
mkdir -p $LAYER_NAME/python
cd $LAYER_NAME

echo "[+] Installation des dépendances..."

# 2. Installer les dépendances dans le dossier python/
pip install -t python mlflow-skinny --upgrade
pip install -t python databricks-cli==0.18.0 --upgrade
pip install -t python "pandas>=1.5.2" --upgrade
pip install -t python tabulate==0.9.0 --upgrade
pip install -t python databricks-sdk --upgrade
pip install -t python wheel --upgrade
pip install -t python protobuf --upgrade
pip install -t python google --upgrade

# Installer mlflow-export-import via .zip
curl -L -o mlflow-export-import.zip https://github.com/mlflow/mlflow-export-import/archive/refs/heads/master.zip
pip install mlflow-export-import.zip -t python --no-deps

# 3. Créer l’archive ZIP avec `python/` à la racine
echo "[+] Zippage du dossier python/"
zip -r9 ../$ZIP_NAME python

cd ..
echo "[✔] ZIP prêt : $ZIP_NAME"
